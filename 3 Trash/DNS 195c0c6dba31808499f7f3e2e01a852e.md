# DNS

DNS (Domain Name System) resolves domain names into IP addresses. It operates without a central database, relying on globally distributed name servers. Key types of DNS servers include:

- **Root Server**: Handles top-level domains (TLDs) and responds when no other server can.
- **Authoritative Server**: Holds authority over a specific zone and provides definitive answers.
- **Non-authoritative Server**: Retrieves DNS information but doesnâ€™t own it.
- **Caching Server**: Temporarily stores DNS responses to speed up queries.
- **Forwarding Server**: Passes queries to another DNS server.
- **Resolver**: Handles name resolution locally on a computer or router.

DNS is mostly unencrypted, making it vulnerable to spying. Secure alternatives include **`DNS over TLS (DoT) on port 853`** and **`DNS over HTTPS (DoH) on port 443`**. Another encryption method is DNSCrypt.

Different `DNS records` are used for the DNS queries, 
which all have various tasks. Moreover, separate entries exist for 
different functions since we can set up mail servers and other servers 
for a domain.

| **DNS Record** | **Description** |
| --- | --- |
| `A` | Returns an IPv4 address of the requested domain as a result. |
| `AAAA` | Returns an IPv6 address of the requested domain. |
| `MX` | Returns the responsible mail servers as a result. |
| `NS` | Returns the DNS servers (nameservers) of the domain. |
| `TXT` | This record can contain various information. The all-rounder can be 
used, e.g., to validate the Google Search Console or validate SSL 
certificates. In addition, SPF and DMARC entries are set to validate 
mail traffic and protect it from spam. |
| `CNAME` | This record serves as an alias for another domain name. If you want 
the domain www.hackthebox.eu to point to the same IP as hackthebox.eu, 
you would create an A record for hackthebox.eu and a CNAME record for 
www.hackthebox.eu. |
| `PTR` | The PTR record works the other way around (reverse lookup). It converts IP addresses into valid domain names. |
| `SOA` | Provides information about the corresponding DNS zone and email address of the administrative contact. |

## Dangerous Settings

There are many ways in which a DNS server can be attacked. For 
example, a list of vulnerabilities targeting the BIND9 server can be 
found at [CVEdetails](https://www.cvedetails.com/product/144/ISC-Bind.html?vendor_id=64). In addition, SecurityTrails provides a short [list](https://securitytrails.com/blog/most-popular-types-dns-attacks) of the most popular attacks on DNS servers.

Some of the settings we can see below lead to these vulnerabilities, 
among others. Because DNS can get very complicated and it is very easy 
for errors to creep into this service, forcing an administrator to work 
around the problem until they find an exact solution. This often leads 
to elements being released so that parts of the infrastructure function 
as planned and desired. In such cases, functionality has a higher 
priority than security, which leads to misconfigurations and 
vulnerabilities.

| **Option** | **Description** |
| --- | --- |
| `allow-query` | Defines which hosts are allowed to send requests to the DNS server. |
| `allow-recursion` | Defines which hosts are allowed to send recursive requests to the DNS server. |
| `allow-transfer` | Defines which hosts are allowed to receive zone transfers from the DNS server. |
| `zone-statistics` | Collects statistical data of zones. |

---

## **Footprinting the Service**

The footprinting at DNS servers is done as a result of the requests 
we send. So, first of all, the DNS server can be queried as to which 
other name servers are known. We do this using the NS record and the 
specification of the DNS server we want to query using the `@`
 character. This is because if there are other DNS servers, we can also 
use them and query the records. However, other DNS servers may be 
configured differently and, in addition, may be permanent for other 
zones.

### DNS

| **Command** | **Description** |
| --- | --- |
| `dig ns <domain.tld> @<nameserver>` | NS request to the specific nameserver. |
| `dig any <domain.tld> @<nameserver>` | ANY request to the specific nameserver. |
| `dig axfr <domain.tld> @<nameserver>` | AXFR request to the specific nameserver. |
| `dnsenum --dnsserver <nameserver> --enum -p 0 -s 0 -o found_subdomains.txt -f ~/subdomains.list <domain.tld>` | Subdomain brute forcing. |

### Zone Transfer

`Zone transfer` refers to the transfer of zones to another 
server in DNS, which generally happens over TCP port 53. This procedure 
is abbreviated `Asynchronous Full Transfer Zone` (`AXFR`).
 Since a DNS failure usually has severe consequences for a company, the 
zone file is almost invariably kept identical on several name servers. 
When changes are made, it must be ensured that all servers have the same
 data. Synchronization between the servers involved is realized by zone 
transfer. Using a secret key `rndc-key`, which we have seen 
initially in the default configuration, the servers make sure that they 
communicate with their own master or slave. Zone transfer involves the 
mere transfer of files or records and the detection of discrepancies in 
the data sets of the servers involved.

### **DIG - AXFR Zone Transfer**

```bash
dig axfr inlanefreight.htb @10.129.14.128
```

If the administrator used a subnet for the `allow-transfer` option for testing purposes or as a workaround solution or set it to `any`,
 everyone would query the entire zone file at the DNS server. In 
addition, other zones can be queried, which may even show internal IP 
addresses and hostname

```bash
dig axfr internal.inlanefreight.htb @10.129.14.128
```

### **Subdomain Brute Forcing**

```bash
for sub in $(cat /opt/useful/seclists/Discovery/DNS/subdomains-top1million-110000.txt);do dig $sub.inlanefreight.htb @10.129.14.128 | grep -v ';\|SOA' | sed -r '/^\s*$/d' | grep $sub | tee -a subdomains.txt;done
```

Many different tools can be used for this, and most of them work in the same way. One of these tools is, for example [DNSenum](https://github.com/fwaeytens/dnsenum).

```bash
dnsenum --dnsserver 10.129.14.128 --enum -p 0 -s 0 -o subdomains.txt -f /opt/useful/seclists/Discovery/DNS/subdomains-top1million-110000.txt inlanefreight.htb

```

```bash
dnsenum --dnsserver 10.129.51.134 --enum -p 0 -s 0 -o subdomains.txt -f /opt/useful/SecLists/Discovery/DNS/fierce-hostlist.txt <subsubdom>.internal.inlanefreight.htb 
```